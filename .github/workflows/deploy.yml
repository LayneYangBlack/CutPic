name: 自动部署到宝塔服务器

# 触发条件：当 main 分支有 push 操作时自动触发
on:
  push:
    branches:
      - main
  # 支持手动触发部署
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境
      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3. 安装依赖
      - name: 安装依赖
        run: npm ci

      # 4. 构建项目
      - name: 构建项目
        run: npm run build

      # 5. 部署到服务器
      - name: 部署到宝塔服务器
        uses: easingthemes/ssh-deploy@v5.1.0
        with:
          # SSH 连接配置（需要在 GitHub Secrets 中配置）
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}

          # 部署配置
          SOURCE: "dist/"                              # 本地构建产物目录
          TARGET: ${{ secrets.REMOTE_TARGET }}         # 服务器目标目录

          # 部署前备份（可选）
          SCRIPT_BEFORE: |
            # 备份当前版本（保留最近 3 个版本）
            if [ -d "${{ secrets.REMOTE_TARGET }}" ]; then
              BACKUP_DIR="${{ secrets.REMOTE_TARGET }}_backup_$(date +%Y%m%d_%H%M%S)"
              cp -r "${{ secrets.REMOTE_TARGET }}" "$BACKUP_DIR"
              echo "已备份到: $BACKUP_DIR"

              # 清理旧备份（只保留最近 3 个）
              cd $(dirname "${{ secrets.REMOTE_TARGET }}")
              ls -dt $(basename "${{ secrets.REMOTE_TARGET }}")_backup_* 2>/dev/null | tail -n +4 | xargs rm -rf
            fi

          # 部署后操作（可选）
          SCRIPT_AFTER: |
            echo "部署完成！"
            echo "部署时间: $(date '+%Y-%m-%d %H:%M:%S')"

            # 可选：重启 Nginx（如果需要）
            # systemctl reload nginx

            # 可选：清理 CDN 缓存（如果使用了 CDN）
            # 这里可以添加清理缓存的命令

      # 6. 部署结果通知（可选）
      - name: 部署成功通知
        if: success()
        run: |
          echo "✅ 部署成功！"
          echo "分支: ${{ github.ref_name }}"
          echo "提交: ${{ github.sha }}"
          echo "提交信息: ${{ github.event.head_commit.message }}"

      - name: 部署失败通知
        if: failure()
        run: |
          echo "❌ 部署失败！请检查日志"
